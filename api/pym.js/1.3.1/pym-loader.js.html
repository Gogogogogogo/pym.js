<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>pym-loader.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-pym.Child.html">Child</a><ul class='methods'><li data-type='method'><a href="module-pym.Child.html#navigateParentTo">navigateParentTo</a></li><li data-type='method'><a href="module-pym.Child.html#onMessage">onMessage</a></li><li data-type='method'><a href="module-pym.Child.html#remove">remove</a></li><li data-type='method'><a href="module-pym.Child.html#scrollParentTo">scrollParentTo</a></li><li data-type='method'><a href="module-pym.Child.html#scrollParentToChildEl">scrollParentToChildEl</a></li><li data-type='method'><a href="module-pym.Child.html#scrollParentToChildPos">scrollParentToChildPos</a></li><li data-type='method'><a href="module-pym.Child.html#sendHeight">sendHeight</a></li><li data-type='method'><a href="module-pym.Child.html#sendHeight">sendHeight</a></li><li data-type='method'><a href="module-pym.Child.html#sendMessage">sendMessage</a></li><li data-type='method'><a href="module-pym.Child.html#~_fire">_fire</a></li><li data-type='method'><a href="module-pym.Child.html#~_markWhetherEmbedded">_markWhetherEmbedded</a></li><li data-type='method'><a href="module-pym.Child.html#~_onWidthMessage">_onWidthMessage</a></li><li data-type='method'><a href="module-pym.Child.html#~_processMessage">_processMessage</a></li></ul></li><li><a href="module-pym.Parent.html">Parent</a><ul class='methods'><li data-type='method'><a href="module-pym.Parent.html#onMessage">onMessage</a></li><li data-type='method'><a href="module-pym.Parent.html#remove">remove</a></li><li data-type='method'><a href="module-pym.Parent.html#sendMessage">sendMessage</a></li><li data-type='method'><a href="module-pym.Parent.html#sendViewportAndIFramePosition">sendViewportAndIFramePosition</a></li><li data-type='method'><a href="module-pym.Parent.html#sendWidth">sendWidth</a></li><li data-type='method'><a href="module-pym.Parent.html#~_constructIframe">_constructIframe</a></li><li data-type='method'><a href="module-pym.Parent.html#~_fire">_fire</a></li><li data-type='method'><a href="module-pym.Parent.html#~_onHeightMessage">_onHeightMessage</a></li><li data-type='method'><a href="module-pym.Parent.html#~_onNavigateToMessage">_onNavigateToMessage</a></li><li data-type='method'><a href="module-pym.Parent.html#~_onResize">_onResize</a></li><li data-type='method'><a href="module-pym.Parent.html#~_onScroll">_onScroll</a></li><li data-type='method'><a href="module-pym.Parent.html#~_onScrollToChildPosMessage">_onScrollToChildPosMessage</a></li><li data-type='method'><a href="module-pym.Parent.html#~_processMessage">_processMessage</a></li><li data-type='method'><a href="module-pym.Parent.html#~_throttleOnScroll">_throttleOnScroll</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-pym.html">pym</a><ul class='methods'><li data-type='method'><a href="module-pym.html#autoInit">autoInit</a></li><li data-type='method'><a href="module-pym.html#~_cleanAutoInitInstances">_cleanAutoInitInstances</a></li><li data-type='method'><a href="module-pym.html#~_getNow">_getNow</a></li><li data-type='method'><a href="module-pym.html#~_getParameterByName">_getParameterByName</a></li><li data-type='method'><a href="module-pym.html#~_isSafeMessage">_isSafeMessage</a></li><li data-type='method'><a href="module-pym.html#~_makeMessage">_makeMessage</a></li><li data-type='method'><a href="module-pym.html#~_makeMessageRegex">_makeMessageRegex</a></li><li data-type='method'><a href="module-pym.html#~_raiseCustomEvent">_raiseCustomEvent</a></li><li data-type='method'><a href="module-pym.html#~_throttle">_throttle</a></li></ul></li><li><a href="module-pym-loader.html">pym-loader</a><ul class='methods'><li data-type='method'><a href="module-pym-loader.html#initializePym">initializePym</a></li><li data-type='method'><a href="module-pym-loader.html#loadPymViaEmbedding">loadPymViaEmbedding</a></li><li data-type='method'><a href="module-pym-loader.html#pageLoaded">pageLoaded</a></li><li data-type='method'><a href="module-pym-loader.html#tryLoadingWithJQuery">tryLoadingWithJQuery</a></li><li data-type='method'><a href="module-pym-loader.html#tryLoadingWithRequirejs">tryLoadingWithRequirejs</a></li><li data-type='method'><a href="module-pym-loader.html#~_raiseCustomEvent">_raiseCustomEvent</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">pym-loader.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
* pym-loader.js is a wrapper library that deals with particular CMS scenarios to successfully load Pym.js into a given page
* To find out more about Pym.js check out the docs at http://blog.apps.npr.org/pym.js/ or the readme at README.md for usage.
*/

/** @module pym-loader */
(function(requirejs, jQuery) {
    /**
    * Create and dispatch a custom pym-loader event
    *
    * @method _raiseCustomEvent
    * @inner
    *
    * @param {String} eventName
    */
   var _raiseCustomEvent = function(eventName) {
     var event = document.createEvent('Event');
     event.initEvent('pym-loader:' + eventName, true, true);
     document.dispatchEvent(event);
   };

    /**
    * Initialize pym instances if Pym.js itself is available
    *
    * @method initializePym
    * @instance
    *
    * @param {String} pym Pym.js loaded library.
    * @param {Boolean} doNotRaiseEvents flag to avoid sending custom events
    */
    var initializePym = function(pym, doNotRaiseEvents) {
        if(pym) {
            if (!doNotRaiseEvents) {
                _raiseCustomEvent("pym-loaded");
            }
            pym.autoInit();
            return true;
        }
        return false;
    };

    /**
     * Load pym with Requirejs if it is available on the page
     * Used in CorePublisher CMS member sites with persistent players
     * Create a different context to allow multiversion
     * via: http://requirejs.org/docs/api.html#multiversion
     *
     * @method tryLoadingWithRequirejs
     * @instance
     *
     * @param {String} pymUrl Url where Pym.js can be found
     */
    var tryLoadingWithRequirejs = function(pymUrl) {
        if (typeof requirejs !== 'undefined') {
            // Requirejs config wants bare name, not the extension
            pymUrl = pymUrl.split(".js")[0];
            var context = 'context_' + pymUrl.split('/').slice(-1)[0];
            // Requirejs detected, create a local require.js namespace
            var require_pym = requirejs.config({
                context: context,
                paths: {
                    'pym': pymUrl,
                 },
                shim: {
                    'pym': { exports: 'pym' }
                }
            });

            // Load pym into local namespace
            require_pym(['require', 'pym'], function(require, pym) {
                initializePym(pym);
            });
            return true;
        }
        return false;
    };

    /**
     * Load pym through jQuery async getScript module
     * Since this loader can be embedded multiple times in the same post
     * the function manages a global flag called pymloading to avoid
     * possible race conditions
     *
     * @method tryLoadingWithJQuery
     * @instance
     *
     * @param {String} pymUrl Url where Pym.js can be found
     */
    var tryLoadingWithJQuery = function(pymUrl) {
        if (typeof jQuery !== 'undefined' &amp;&amp; typeof jQuery.getScript === 'function') {
            jQuery.getScript(pymUrl).done(function() {
                initializePym(window.pym);
            });
            return true;
        }
        return false;
    };

    /**
     * As another loading fallback approach
     * try to append the script tag to the head of the document
     * via http://stackoverflow.com/questions/6642081/jquery-getscript-methods-internal-process
     * via http://unixpapa.com/js/dyna.html
     *
     * @method loadPymViaEmbedding
     * @instance
     *
     * @param {String} pymUrl Url where Pym.js can be found
     */
    var loadPymViaEmbedding = function(pymUrl) {
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = pymUrl;
        script.onload = function() {
            // Remove the script tag once pym it has been loaded
            if (head &amp;&amp; script.parentNode) {
                head.removeChild(script);
            }
            initializePym(window.pym);
        };
        head.appendChild(script);
    };

    var pymUrl = "@@defaultPymUrl";
    // @ifdef ENV='production'
    // remove local test code
    /* Check for karma local testing, if the replacement has not been done yet on the build process */
    if (pymUrl.lastIndexOf('@@', 0) === 0) { pymUrl = '/base/src/pym.js'; }
    // @endif
    tryLoadingWithRequirejs(pymUrl) || tryLoadingWithJQuery(pymUrl) || loadPymViaEmbedding(pymUrl);

    /**
     * Callback to initialize Pym.js on document load events
     *
     * @method pageLoaded
     * @instance
     */
    var pageLoaded = function() {
        document.removeEventListener("DOMContentLoaded", pageLoaded);
        window.removeEventListener("load", pageLoaded);
        return initializePym(window.pym, true);
    };

    // Listen to page load events to account for pjax load and sync issues
    window.document.addEventListener("DOMContentLoaded", pageLoaded);
    // Fallback for wider browser support
    window.addEventListener("load", pageLoaded);

})(window.requirejs, window.jQuery);
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Tue Jul 25 2017 09:57:28 GMT-0400 (EDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
